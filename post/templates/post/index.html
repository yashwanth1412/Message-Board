{% extends "post/layout.html" %}

{% block content %}
    <div class="post-container">
        {% for post in posts %}
            <a href="{% url 'post:view_post' post.id %}" class="post_link">
                <div class="post">
                    <div class="post_user">
                        <img src="{{post.author.profile.profile_pic.url}}" class='post_pic' loading="lazy">
                        <div class="details">
                            <div class="author"> Posted by 
                                {% if request.user == post.author %}
                                    You
                                {% else %}
                                    {{ post.author.first_name}}
                                {% endif %}
                            </div>
                            <div class="date"> {{ post.date_posted }} </div>
                        </div>
                    </div>  
                    <div class="post_content">
                        <h1 class="title"> {{ post.title|title }} </h1>
                        <div class="content"> {{ post.content }} </div>
                    </div>
                </div>
            </a>
            <hr style="width:50%; margin: auto; color:rgb(37, 32, 32);"> 
        {% empty %}
            <div class="empty">
                <h1> {{message}}</h1>
                <a href="{% url empty_btn_url %}" class="btn btn-dark">{{ empty_msg }}</a>
            </div>
        {% endfor %}
    </div>

    {% if index %}
        <script>
            var loc = window.location
            var wsSrt = "ws://"
            if(loc.protocol == "https:"){
                wsSrt = "wss://"
            }
            var endpoint = wsSrt + loc.host + "/post"
            console.log(endpoint)
            var socket = new WebSocket(endpoint)
            var post_container = $(".post-container")
            socket.onmessage = (e) => {
                $.ajax({
                        type: "GET",
                        url : "{% url 'post:ajax_getPosts' %}",
                        dataType: 'html',
                        success: (response) => {
                            $(".post-container").html(response)
                        },
                        error: (response) => {
                            console.log("No data received")
                        }
                    });
            }

            socket.onerror = (e) => {
                console.log("error", e)
            }

            socket.onclose = (e) => {
                console.log("close", e)
            }
        </script>
    {% endif %}

{% endblock %}
