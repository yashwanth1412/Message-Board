{% extends "post/layout.html" %}

{% block content %}
    {% if index %} 

        <form add="{% url 'post:add_post' %}" method="POST">
            {% csrf_token %}
            {{form}}
            <input type="submit" value="Add">
        </form>
    
        <a href="{% url 'post:my_posts' %}">Your posts</a>
        <a href="{% url 'users:index' %}">Home</a>
    {% else %}
        <a href="{% url 'post:index' %}">All Posts</a>
    {% endif %}

    <div class="post-container">
        {% for post in posts %}
            <a href="{% url 'post:view_post' post.id %}" class="post_link">
                <div class="post">
                    <img src="{{post.author.profile.profile_pic.url}}" class='post_pic'>
                    <h1 class="title"> {{ post.title }} </h1>
                    <div class="details">
                        <div class="author"> Posted by 
                            {% if request.user == post.author %}
                                You
                            {% else %}
                                {{ post.author.first_name}}
                            {% endif %}
                        </div>
                        <div class="date"> {{ post.date_posted }} </div>
                    </div>  
                    <div class="content"> {{ post.content }} </div>
                </div>
            </a>
            <hr style="width:50%; margin: auto; color:rgb(37, 32, 32);"> 
        {% empty %}
            <div class="empty">
                <h1> {{message}}</h1>
                <a href="{% url 'post:add_post' %}">Add post</a>
            </div>
        {% endfor %}
    </div>

    <script>
        var loc = window.location
        var wsSrt = "ws://"
        if(loc.protocol == "https:"){
            wsSrt = "wss://"
        }
        var endpoint = wsSrt + loc.host + "/post"
        console.log(endpoint)
        var socket = new WebSocket(endpoint)
        var form = $("form")
        var title = $("#id_title")
        var content = $("#id_content")
        var post_container = $(".post-container")

        socket.onopen = (e) => {
            form.submit(e => {
                e.preventDefault()
                socket.send(JSON.stringify({
                    'title' : title.val(),
                    'content' : content.val()
                }))

                form.trigger("reset")
            })
        }

        socket.onmessage = (e) => {
            $.ajax({
                    type: "GET",
                    url : "{% url 'post:ajax_getPosts' %}",
                    dataType: 'html',
                    success: (response) => {
                        $(".post-container").html(response)
                    },
                    error: (response) => {
                        console.log("No data received")
                    }
                });
        }

        socket.onerror = (e) => {
            console.log("error", e)
        }

        socket.onclose = (e) => {
            console.log("close", e)
        }

    </script>

{% endblock %}
